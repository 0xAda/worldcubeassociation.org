<%# Generate round informations for the competition %>
<% rounds_by_wcif_id = Hash[competition.rounds.map { |r| [r.wcif_id, r.to_string_map] }] %>
<script>
  var roundsByWcifId = <%= raw(rounds_by_wcif_id.to_json) %>;
  var dataByVenueId = {};
</script>
<ul class="nav nav-pills nav-justified">
  <% competition.competition_venues.each_with_index do |venue, index| %>
    <li class="<%= (index == 0) ? "active" : "" %>"><a href="#schedule-venue-<%= venue.id %>" data-toggle="pill"><%= venue.name %></a></li>
  <% end %>
</ul>
<div class="tab-content" id="schedule-tab">
  <% competition.competition_venues.each_with_index do |venue, index| %>
    <div class="tab-pane <%= (index == 0) ? "active" : "" %>" id="schedule-venue-<%= venue.id %>" data-venue="<%= venue.id %>">
      <p>
        <%= t("competitions.schedule.venue_information_html", venue_name: link_to_google_maps_place(venue.name, venue.latitude_degrees, venue.longitude_degrees)) %>
        <br />
        <%= t("competitions.schedule.timezone_message", timezone: venue.timezone_id) %>
        <% if competition.competition_venues.size > 1 %>
          <br />
          <%= t("competitions.schedule.multiple_venues_available") %>
        <% end %>
      </p>
      <% venue_rooms = venue.venue_rooms %>
      <div class="row">
        <div class="col-xs-12 col-md-6">
          Display the schedule as
          <div class="list-group">
            <a class="list-group-item active schedule-table-link" href="#">Table</a>
            <a class="list-group-item schedule-calendar-link" href="#">Calendar</a>
          </div>
        </div>
        <%# We want to keep these elements in the html for the event filter. %>
        <div class="col-xs-12 col-md-6 <%= "hidden" if venue.venue_rooms.size <= 1 %>">
          Display schedule for:
          <div class="list-group" id="room-list-<%= venue.id %>">
            <% venue_rooms.each do |r| %>
              <a class="list-group-item room-enabled toggle-room" href="#" data-room="<%= r.id %>"><%= r.name %></a>
            <% end %>
          </div>
        </div>
      </div>
      <%
        activities = venue.all_activities
        sorted_activities = activities.sort_by { |a| a.start_time.strftime("%H:%M") }
        firstActivity = sorted_activities.first
        firstTime = if firstActivity
                      firstActivity.start_time.in_time_zone(venue.timezone_id).strftime("%H:00:00")
                    else
                      "08:00:00"
                    end
        lastAtivity = sorted_activities.last
        lastTime = if lastAtivity
                     lastAtivity.end_time.in_time_zone(venue.timezone_id).strftime("%H:59:00")
                    else
                      "20:00:00"
                    end
        activities.map!(&:to_event)
      %>
      <script>
        dataByVenueId["<%= venue.id %>"] = {
          events: <%= raw(activities.to_json) %>,
          minTime: "<%= firstTime %>",
          maxTime: "<%= lastTime %>",
        }
      </script>
      <div class="schedule_table_container">
        <%= render "competition_schedule_for_venue_table", competition: competition, rounds_by_wcif_id: rounds_by_wcif_id, activities: activities %>
      </div>
      <div class="schedule_calendar_container" style="display: none;">
        <div id="calendar-venue-<%= venue.id %>"></div>
      </div>
    </div>
  <% end %>
  <div class="time-limit-information">
    <dl class="dl-horizontal">
      <%# FIXME: i18n %>
      <dt id="time-limit">Time Limit</dt>
      <dd>
      If you reach the time limit during your solve, the judge will stop you and your result will be DNF (see <%= link_to "Regulation A1a4",  regulations_path + "#A1a4", target: "_blank" %>).
      <br/>
      A <strong id="cumulative-time-limit">cumulative time limit</strong> may be enforced (see <%= link_to "Regulation A1a2",  regulations_path + "#A1a2", target: "_blank" %>).
      <br/>
      A <strong id="cumulative-across-rounds-time-limit">cumulative time limit</strong> may be enforced across rounds (see <%= link_to "Guideline A1a2++",  regulations_path + "/guidelines.html#A1a2++", target: "_blank" %>).
      </dd>

      <dt id="cutoff">Cutoff</dt>
      <dd>The ranking or time to meet to proceed to the second phase of a combined round (see <%= link_to "Regulation 9g",  regulations_path + "#9g", target: "_blank" %>)</dd>
    </dl>
  </div>
</div>
<script>
$(".toggle-room").click(function(e) {
  e.preventDefault();
  var $elem = $(this);
  var $tab = $("#schedule-tab > .tab-pane.active");
  var venueId = $tab.data("venue");
  var roomId = $elem.data("room");
  $(".room-" + roomId).toggle();
  $calendar = $("#calendar-venue-" + venueId);
  if ($elem.hasClass("room-enabled")) {
    $elem.removeClass("room-enabled");
  } else {
    $elem.addClass("room-enabled");
  }
  $elem.blur();
  if ($calendar.hasClass("initialized")) {
    $calendar.fullCalendar("refetchEvents");
  }
});

function fetchCalendarEvents(venueId, start, end, timezone, callback) {
  // We don't really care about timezone or start/end as we only have events for a specific competition and venue.
  var venueData = dataByVenueId[venueId];
  var allEvents = venueData.events;
  var rooms = $("#room-list-" + venueId).find(".room-enabled");
  var events = _.flatMap(rooms, function(room) {
    let roomId = $(room).data("room");
    return _.filter(allEvents, { roomId });
  });

  callback(events);
}

function initFullCalendar($elem, venueId) {
  var venueData = dataByVenueId[venueId];
  var options = {
    events: _.partial(fetchCalendarEvents, venueId),
    defaultView: 'agendaForComp',
    header: false,
    allDaySlot: false,
    locale: "<%= I18n.locale %>",
    minTime: venueData.minTime,
    maxTime: venueData.maxTime,
    slotDuration: "00:30:00",
    height: "auto",
    defaultDate: "<%= competition.start_date %>",
    // see: https://fullcalendar.io/docs/views/Custom_Views/
    views: {
      agendaForComp: {
        type: 'agenda',
        duration: { days: <%= competition.number_of_days %> },
        buttonText: 'Calendar',
      },
    },
  }
  $elem.fullCalendar(options);
}

$(".schedule-calendar-link").click(function(e) {
  e.preventDefault();
  var $tab = $("#schedule-tab > .tab-pane.active");
  var venueId = $tab.data("venue");
  $tab.find(".schedule_table_container").hide();
  $tab.find(".schedule-table-link").removeClass("active");
  $tab.find(".schedule_calendar_container").show();
  $tab.find(".schedule-calendar-link").addClass("active");
  $calendar = $("#calendar-venue-" + venueId);
  if (!$calendar.hasClass("initialized")) {
    $calendar.addClass("initialized");
    initFullCalendar($calendar, venueId);
  }
});
$(".schedule-table-link").click(function(e) {
  e.preventDefault();
  var $tab = $("#schedule-tab > .tab-pane.active");
  $tab.find(".schedule_calendar_container").hide();
  $tab.find(".schedule-calendar-link").removeClass("active");
  $tab.find(".schedule_table_container").show();
  $tab.find(".schedule-table-link").addClass("active");
});
</script>
