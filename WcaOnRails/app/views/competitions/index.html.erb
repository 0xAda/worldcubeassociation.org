<% provide(:title, 'Competitions') %>

<div class="container">
  <h2><%= yield(:title) %></h2>

  <div id="scroller-anchor"></div>
  <div id="scroller">
    <ul>
      <% if @in_progress_competitions.length > 0 %>
        <li><a href="#current">Competitions in progress</a></li>
      <% else %>
        <li>There are no competitions today.</li>
      <% end %>

      <% if @upcoming_competitions.length > 0 %>
        <li><a href="#upcoming">Upcoming competitions</a></li>
      <% else %>
        <li>There are no upcoming competitions selected.</li>
      <% end %>

      <% if @past_competitions.length > 0 %>
        <li><a href="#past">Past competitions</a></li>
      <% else %>
        <li>There are no past competitions selected.</li>
      <% end %>
    </ul>

    <%= form_tag competitions_path, method: :get, class: "competition-select form-inline" do %>
      <%= render 'index_form' %>
    <% end %>
  </div>
    <% if @competitions.length == 0 %>
      <div class="alert alert-warning">No competitions found</div>
    <% else %>
      <% if params[:display] == "List" %>
        <div class="row competition-list">
          <div class="col-md-12" id="current">
            <% if @in_progress_competitions.length > 0 %>
              <%= render 'index_table', competitions: @in_progress_competitions, title: "Competitions in progress" %>
              <% end %>
          </div>

          <div class="col-md-6" id="upcoming">
            <%= render 'index_table', competitions: @upcoming_competitions, title: "Upcoming competitions" %>
          </div>
          <div class="col-md-6" id="past">
            <%= render 'index_table', competitions: @past_competitions, title: "Past competitions" %>
          </div>
        </div>
      <% else %>
        <div class="row competition-list">
          <div class="col-xs-12 col-md-12">
            <div id="map"></div>
          </div>
        </div>
      <% end %>
    <% end %>
</div>

<script>
function moveScroller() {
    var move = function() {
        var st = $(window).scrollTop();
        var ot = $("#scroller-anchor").offset().top;
        var s = $("#scroller");
        if(st > ot) {
            s.css({
                position: "fixed",
                top: "0px",
                "z-index": 10
            });
        } else {
            if(st <= ot) {
                s.css({
                    position: "relative",
                    top: ""
                });
            }
        }
    };
    $(window).scroll(move);
    move();
}

function mapSize() {
  var nav = parseInt($(".navbar").outerHeight(true));
  var head = parseInt($("h2").outerHeight(true));
  var form = parseInt($(".form-group").outerHeight(true));
  var foot = parseInt($(".footer").outerHeight(true));

  var height = parseInt($(window).innerHeight());

  var map = height - nav - head - form - foot;

  $("#map").height( map );
}

$(window).resize(function() {
  mapSize();
});

$(function() {
  <% if params[:display] == 'Map' %>
    var competitions = <%= @competitions.map do |c|
        {
          id: c.id,
          name: c.name,
          latitude_degrees: c.latitude_degrees,
          longitude_degrees: c.longitude_degrees,
          cityName: c.cityName,
          marker_date: c.start_date.to_formatted_s(:long),
          is_over: c.is_over?,
          url: competition_path(c)
        }
      end.to_json.html_safe %>;

    $("#map").competitionsMap(competitions);
  <% end %>

  mapSize();

  if (!detect_mobile()) {
    moveScroller();
  }
});
</script>
