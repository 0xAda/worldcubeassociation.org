<% provide(:title, 'Competitions') %>

<div class="container">
  <h2><%= yield(:title) %></h2>

  <%= form_tag competitions_path, method: :get, class: "competition-select" do %>
    <div class="form-group same-line">
      Event: <br /<br /><%= select_tag(:event, options_for_select(@events, params[:event])) %>
    </div>

    <div class="form-group same-line">
      Region: <br /<br /><%= select_tag(:region, options_for_select(@regions, params[:region])) %>
    </div>

    <div class="form-group same-line">
      Years: <br /<br /><%= select_tag(:years, options_for_select(@years, params[:years])) %>
    </div>

    <div class="form-group same-line">
      Name, City or Venue: <br /<br /><%= text_field_tag "search" %></td>
    </div>

    <%= submit_tag "List" %>
    <%= submit_tag "Map" %>
  <% end %>

  <% if params[:commit] == "List" %>
    <table class="table competitions-table table-striped table-hover">
      <tr>
        <th>Year</th>
        <th>Date</th>
        <th>Name</th>
        <th></th>
        <th>Country, City</th>
        <th>Venue</th>
        <th class="big-column"></th>
      </tr>

      <% @competitions.each_with_index do |competition, index| %>
        <% if index == (@closest_index-1) %>
          <tr class="bg-primary">
            <td colspan="6" class="text-center">Today</td>
            <td></td>
          </tr>
        <% else %>
          <tr class="<%= competition.is_over? ? "past" : "future" %>">
            <td><%= competition.year %></td>
            <td><%= date_range(competition.start_date, competition.end_date, separator: '-', show_year: false) %></td>
            <td>
              <% anchor_tag = @closest_index && (index == (@closest_index - 10)) %>
              <%= link_to competition.name, competition_path(competition), id: anchor_tag ? "today" : "" %>
            </td>
            <td>
              <% if competition.results.length > 0 %>
                <span class="glyphicon glyphicon-ok-sign" aria-hidden="true" data-toggle="tooltip" data-placement="top" data-container="body" title="Results are up!"></span>
              <% end %>
            </td>
            <td><%= wca_highlight competition.country.name + ", " + competition.cityName, competition.country.name %></td>
            <td><%= competition.venue %></td>
            <td></td>
          </tr>
        <% end %>
      <% end %>
    </table>
  <% else %>
    <div id="venue-map-wrapper">
      <div class="map"></div>
    </div>
  <% end %>

</div>

<script>
$(function() {
    var $today = document.getElementById("today");
    if ($today)
      $(document).scrollTop( $("#today").offset().top );

    var $map = $('#venue-map-wrapper .map');
    $map.locationpicker({
      zoom: 2,
      location: {
        latitude: 0,
        longitude: 0,
      },
      radius: 0,
      scrollwheel: false,
      oninitialized: function(currentLocation, radius, isMarkerDropped) {
        wca.setCompetitions(<%= @competitions.map do |c|
        {
          id: c.id,
          name: c.name,
          latitude_degrees: c.latitude_degrees,
          longitude_degrees: c.longitude_degrees,
          start_date: c.start_date,
          end_date: c.end_date,
          year: c.year,
          month: c.month,
          day: c.day,
          cityName: c.cityName,
        }
      end.to_json.html_safe %>);
      },
    });
    var locationpicker = $map.data('locationpicker');

    wca.setCompetitions = function(competitions) {
      var desiredCompetitionById = _.indexBy(competitions, 'id');

      var desiredIds = Object.keys(desiredCompetitionById);
      desiredIds.forEach(function(id) {
      var c = desiredCompetitionById[id];

      var contentString = "<a href='/competitions/" + c.id + "'>" + c.name + "</a><br />" + (new Date(c.year, c.month-1, c.day)).toLocaleFormat("%b %d, %Y") + " - " + c.cityName;

      var infowindow = new google.maps.InfoWindow({
        content: contentString
      });

      c.marker = new google.maps.Marker({
        map: locationpicker.map,
        position: {
          lat: c.latitude_degrees,
          lng: c.longitude_degrees,
        },
        title: c.name,
      });

      c.marker.addListener('click', function() {
        infowindow.open(locationpicker.map, c.marker);
      });
    });
  };
});
</script>
