<% provide(:title, 'Competitions') %>

<div class="container">
  <h2><%= yield(:title) %></h2>

  <%= form_tag competitions_path, method: :get, class: "competition-select form-inline", id: "comp-query-form" do %>
    <%= render 'index_form' %>
  <% end %>

  <% if @competitions.empty? %>
    <div class="alert alert-warning">
      <%= unless params[:event_ids].empty?
        "We didn't find any competitions with those #{ pluralize(params[:event_ids].count, "event" )}! Try searching for fewer events."
      else
        "No competitions found."
      end %>
    </div>
  <% else %>
    <% if params[:display] == "list" %>
      <div class="row competition-list">
        <% if @past_selected %>
          <div class="col-md-12" id="past">
            <%= render 'index_table', competitions: @competitions, title: "Past competitions from #{params[:year]}" %>
          </div>
        <% else %>
          <% @in_progress_competitions, @upcoming_competitions = @competitions.partition(&:in_progress?) %>
          <% unless @in_progress_competitions.empty? %>
            <div class="col-md-12" id="current">
              <%= render 'index_table', competitions: @in_progress_competitions, title: "Competitions in progress" %>
            </div>
          <% end %>
          <% unless @upcoming_competitions.empty? %>
            <div class="col-md-12" id="upcoming">
              <%= render 'index_table', competitions: @upcoming_competitions, title: "Upcoming competitions" %>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="row competition-list">
        <div class="col-xs-12 col-md-12">
          <div id="comps-map"></div>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<script>
// See https://github.com/cubing/worldcubeassociation.org/issues/356
function mapSize() {
  var nav = parseInt($(".navbar").outerHeight(true));
  var head = parseInt($("h2").outerHeight(true));
  var form = parseInt($(".form-group").outerHeight(true));
  var foot = parseInt($(".footer").outerHeight(true));

  var height = parseInt($(window).innerHeight());

  var map = height - nav - head - form - foot;

  $("#comps-map").height( map );
}

$(function() {
  <% if params[:display] == 'map' %>
    var competitions = <%= @competitions.map do |c|
        {
          id: c.id,
          name: c.name,
          latitude_degrees: c.latitude_degrees,
          longitude_degrees: c.longitude_degrees,
          cityName: c.cityName,
          marker_date: c.start_date.to_formatted_s(:long),
          is_over: c.is_over?,
          url: competition_path(c)
        }
      end.to_json.html_safe %>;

    $("#comps-map").competitionsMap(competitions);

    mapSize();

    $(window).resize(function() {
      mapSize();
    });
  <% end %>

  $(".disabled").each(function() {
    $(this).removeAttr('href');
  });
});
</script>

