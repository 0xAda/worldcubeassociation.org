<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <%= favicon_link_tag 'wca.ico' %>
  <title><%= full_title(yield(:title)) %></title>
  <%= stylesheet_link_tag 'application', media: 'all' %>
  <%= javascript_include_tag 'application' %>
  <script type="text/javascript" src='//maps.google.com/maps/api/js?libraries=places'></script>
  <%= csrf_meta_tags %>
  <%= auto_discovery_link_tag(:rss, rss_url(format: :xml)) %>
  <% if ENVied.WCA_LIVE_SITE %>
    <script>
      // See http://blog.ruigomes.me/google-universal-analytics-tracking-with-rails-4/
      (function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,"script","//www.google-analytics.com/analytics.js","ga");
      ga("create", "UA-41256017-1", "auto");
      ga("set", "anonymizeIp", true);
    </script>
  <% end %>
  <% if @omni_query.present? %>
    <script>
      $(function() {
        $('.wca-autocomplete-omni').each(function() {
          var selectize = this.selectize;
          // We're only interested in touching the original input, *not* the duplicate
          // that selectize created. The original input has a selectize attribute.
          if(selectize) {
            selectize.$control_input.val(<%= @omni_query.to_json.html_safe %>);
            selectize.$control_input.trigger("update");
          }
        });
      });
    </script>
  <% end %>
</head>
<body data-rails-controller-name="<%= controller_name %>" data-rails-controller-action-name="<%= action_name %>">

  <!-- Static navbar -->
  <div class="navbar navbar-default navbar-static-top" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a href="/"><%= image_tag "wca_logo.svg" %></a>
        <a href="/"><span>World Cube Association</span></a>
      </div>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <div class="navbar-collapse collapse disabled">
        <ul class="nav navbar-nav">
          <li class="dropdown <%= params[:controller] == 'static_pages' || params[:controller] == 'posts' ? 'active' : '' %>">
            <a href="/" class="dropdown-toggle top-nav" data-toggle="dropdown" data-hover="dropdown">
              <%= icon('info-circle', class: 'fa-fw') %> <span class="hidden-sm">Information</span> <span class="caret"></span>
            </a>
            <ul class="dropdown-menu" role="menu">
              <li><a href="/about"><%= icon('file-text', class: 'fa-fw') %> About the WCA</a></li>
              <li><a href="/delegates"><%= icon('sitemap', class: 'fa-fw') %> WCA Delegates</a></li>
              <li><a href="/organisations"><%= icon('flag', class: 'fa-fw') %> National Organisations</a></li>
              <li class="divider"></li>
              <li><a href="/contact"><%= icon('envelope', class: 'fa-fw') %> Contact Information</a></li>
              <li><a href="/forum/" class="top-nav"><%= icon('comments', class: 'fa-fw') %> Forum</a></li>
              <li class="divider"></li>
              <li><a href="/score-tools"><%= icon('wrench', class: 'fa-fw') %> Tools</a></li>
              <li><a href="/logo"><%= image_tag('wca_logo.svg', width: '16px', class: 'fa-fw') %> Logo</a></li>
            </ul>
          </li>
          <li><a href="/results/competitions.php" class="top-nav"><%= icon('globe', class: 'fa-fw') %> Competitions</a></li>
          <li class="dropdown">
            <a href="/results/" class="dropdown-toggle top-nav" data-toggle="dropdown" data-hover="dropdown">
              <%= icon('list-ol', class: 'fa-fw') %> Results <span class="caret"></span>
            </a>
            <ul class="dropdown-menu" role="menu">
              <li><a href="/results/events.php"><%= icon('signal', class: 'fa-fw fa-rotate-90') %> Rankings</a></li>
              <li><a href="/results/regions.php"><%= icon('trophy', class: 'fa-fw') %> Records</a></li>
              <li><a href="/results/persons.php"><%= icon('user', class: 'fa-fw') %> Persons</a></li>
              <li class="divider"></li>
              <li><a href="/results/statistics.php"><%= icon('area-chart', class: 'fa-fw') %> Statistics</a></li>
              <li><a href="/results/media.php"><%= icon('film', class: 'fa-fw') %> Multimedia</a></li>
              <li><a href="/results/misc/export.html"><%= icon('download', class: 'fa-fw') %> Database Export</a></li>
            </ul>
          </li>
          <li class="dropdown <%= params[:controller] == 'regulations' ? 'active' : '' %>">
            <a href="/regulations/" class="dropdown-toggle top-nav" data-toggle="dropdown" data-hover="dropdown">
              <%= icon('book', class: 'fa-fw') %> <span class="hidden-sm">Regulations</span> <span class="caret"></span>
            </a>
            <ul class="dropdown-menu" role="menu">
              <li><a href="/regulations/"><%= icon('book', class: 'fa-fw') %> Regulations</a></li>
              <li><a href="/regulations/guidelines.html"><%= icon('question-circle', class: 'fa-fw') %> Guidelines</a></li>
              <li><a href="/regulations/scrambles/"><%= icon('random', class: 'fa-fw') %> Scrambles</a></li>
              <li class="divider"></li>
              <li><a href="/regulations/history/"><%= icon('history', class: 'fa-fw') %> History</a></li>
              <li><a href="/regulations/translations/"><%= icon('language', class: 'fa-fw') %> Translations</a></li>
            </ul>
          </li>
        </ul>

        <form class="navbar-form navbar-left" role="search">
          <%= wca_omni_search %>
        </form>

        <ul class="nav navbar-nav navbar-right">
          <li class="dropdown">
            <a href="#" class="dropdown-toggle top-nav" data-toggle="dropdown" data-hover="dropdown">
              <% if current_user %>
                <% notification_count = notifications_for_user(current_user).length %>
                <%= render "shared/user_avatar", user: current_user, do_not_show_full_image_on_hover: true %>
                <% if notification_count > 0 %>
                  <span class="badge"><%= notification_count %></span>
                <% end %>
              <% else %>
                <span class="hidden-sm">Sign in</span>
              <% end %>
              <span class="caret"></span>
            </a>
            <ul class="dropdown-menu" role="menu">
              <% if current_user %>
                <li role="presentation" class="dropdown-header">
                  <%= current_user.name %>
                </li>
                <li>
                  <%= link_to notifications_path do %>
                    Notifications
                    <% if notification_count > 0 %>
                      <span class="badge"><%= notification_count %></span>
                    <% end %>
                  <% end %>
                </li>
                <li><%= link_to "Edit account", users_edit_path %></li>
                <% if current_user.can_edit_users? %>
                  <li class="divider"></li>
                  <li role="presentation" class="dropdown-header">
                    Administration
                  </li>
                  <li><%= link_to "Manage users", users_path %></li>
                <% end %>

                <% if current_user.any_kind_of_delegate? %>
                  <li class="divider"></li>
                  <li role="presentation" class="dropdown-header">
                    Delegate
                  </li>
                  <li><%= link_to "Panel", delegate_path %></li>
                  <li><%= link_to "New competition", new_competition_path %></li>
                <% end %>

                <% if current_user.can_admin_results? %>
                  <li class="divider"></li>
                  <li role="presentation" class="dropdown-header">
                    Results team
                  </li>
                  <li><%= link_to "Admin", admin_path %></li>
                  <li><%= link_to "Competitions", competitions_path %></li>
                  <li><%= link_to "phpMyAdmin", '/results/admin/phpMyAdmin/' %></li>
                <% end %>

                <li class="divider"></li>
                <% if current_user.can_create_posts? %>
                  <li><%= link_to "New post", new_post_path %></li>
                <% end %>

                <li class="divider"></li>
                <li><%= link_to('Sign out', destroy_user_session_path, :method => :delete) %></li>
              <% else %>
                <li><%= link_to('Sign in', new_user_session_path, class: "top-nav") %></li>
                <li class="divider"></li>
                <li><%= link_to t('.didn_t_receive_confirmation_instructions', :default => "Didn't receive confirmation instructions?"), new_user_confirmation_path %></li>
              <% end %>
            </ul>
          </li>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </div>

  <div class="container">
    <% flash.each do |message_type, message| %>
      <div class="alert <%= bootstrap_class_for message_type %> alert-dismissible">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <%= message %>
      </div>
    <% end %>
  </div>
  <%= yield %>

  <footer class="footer">
    <div class="container">
      <p class="text-muted">
        <%= link_to "Contact", contact_website_path %>
        |
        <a href="https://github.com/cubing/worldcubeassociation.org" target="_blank" class="hide-new-window-icon">
          <i class="fa fa-github"></i>
        </a>
      </p>
    </div>
  </footer>

  <% if ENVied.WCA_LIVE_SITE %>
    <script>
      // See http://blog.ruigomes.me/google-universal-analytics-tracking-with-rails-4/
      ga('send', 'pageview', '<%= request.path %>');
    </script>
  <% end %>
</body>
</html>
