<% provide(:title, @person.name) %>

<div class="container" id="person">
  <div class="text-center">
    <h2><%= @person.name %></h2>
    <% if @person&.user&.avatar %>
      <%= image_tag @person.user.avatar, class: "avatar" %>
    <% end %>
  </div>

  <div class="table-responsive details">
    <table class="table table-striped">
      <thead>
        <tr>
          <th><%= t 'common.country' %></th>
          <th><%= t 'common.user.wca_id' %></th>
          <%= content_tag :th, t('activerecord.attributes.person.gender') if @person.gender.present? %>
          <th><%= t 'layouts.navigation.competitions' %></th>
          <th><%= t '.completed_solves' %></th>
        </tr>
      </thead>
      <tbody>
        <td><i class="flag f16 <%= @person.country_iso2.downcase %>"></i> <%= @person.country.name %></td>
        <td><%= @person.wca_id %></td>
        <%= content_tag :td, User::GENDER_LABEL_METHOD.call(@person.gender.to_sym) if @person.gender.present? %>
        <td><%= @person.competitions.count %></td>
        <td><%= @person.completed_solves_count %></td>
      </tbody>
    </table>
  </div>

  <div class="personal-records">
    <h3><%= t '.personal_records' %></h3>
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th class="event"><%= t 'competitions.results_table.event' %></th>
            <th class="country-rank">NR</th>
            <th class="continent-rank">CR</th>
            <th class="world-rank">WR</th>
            <th class="single"><%= t 'common.single' %></th>
            <th class="average"><%= t 'common.average' %></th>
            <th class="world-rank">WR</th>
            <th class="continent-rank">CR</th>
            <th class="country-rank">NR</th>
          </tr>
        </thead>
        <tbody>
          <% @events_competed_in.each do |event| %>
            <% rank_single = @ranks_single.find { |rank| rank.event_id == event.id } %>
            <% rank_average = @ranks_average.find { |rank| rank.event_id == event.id } %>
            <tr>
              <td class="event">
                <%= content_tag :span, "", class: "cubing-icon event-#{event.id}" %>
                <%= t "events.#{event.id}" %>
              </td>
              <%= rank_td rank_single, "country" %>
              <%= rank_td rank_single, "continent" %>
              <%= rank_td rank_single, "world" %>
              <td class="single"><%= rank_single %></td>
              <td class="average"><%= rank_average %></td>
              <%= rank_td rank_average, "world" %>
              <%= rank_td rank_average, "continent" %>
              <%= rank_td rank_average, "country" %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <% if @world_championship_podiums.any? %>
    <div class="wc-podiums">
      <h3><%= t '.wc_podiums' %></h3>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th class="event"><%= t 'competitions.results_table.event' %></th>
              <th class="place"><%= t '.place' %></th>
              <th class="single"><%= t 'common.single' %></th>
              <th class="average"><%= t 'common.average' %></th>
              <th class="solves" colspan="5"><%= t 'common.solves' %></th>
            </tr>
          </thead>
          <tbody>
            <% @world_championship_podiums.group_by(&:competition).each do |competition, results| %>
              <tr>
                <td colspan="9">
                  <%= link_to competition.name, competition, class: "competition-link" %>
                </td>
              </tr>
              <% results.each do |result| %>
                <tr class="result">
                  <td class="event">
                    <%= content_tag :span, "", class: "cubing-icon event-#{result.event.id}" %>
                    <%= t "events.#{result.event.id}" %>
                  </td>
                  <td class="place"><%= result.pos %></td>
                  <td class="single"><%= result.best_solve.clock_format %></td>
                  <td class="average"><%= result.average_solve.clock_format %></td>
                  <%= solve_tds_for_result(result) %>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <% if @medals[:total] > 0 %>
    <div class="col-md-6 medal-collection">
      <h3><%= t '.medal_collection' %></h3>
      <table class="table table-striped">
        <thead>
          <tr>
            <th><%= t '.medals.gold' %></th>
            <th><%= t '.medals.silver' %></th>
            <th><%= t '.medals.bronze' %></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><%= @medals[:gold] %></td>
            <td><%= @medals[:silver] %></td>
            <td><%= @medals[:bronze] %></td>
          </tr>
        </tbody>
      </table>
    </div>
  <% end %>

  <% if @records[:total] > 0 %>
    <div class="col-md-6 record-collection">
      <h3><%= t '.record_collection' %></h3>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>WR</th>
            <th>CR</th>
            <th>NR</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><%= @records[:world] if @records[:world] > 0 %></td>
            <td><%= @records[:continental] if @records[:continental] > 0 %></td>
            <td><%= @records[:national] if @records[:national] > 0 %></td>
          </tr>
        </tbody>
      </table>
    </div>
  <% end %>

  <div class="results-by-event">
    <h3><%= t '.results' %></h3>
    <!-- events radio -->
    <div class="event-selector">
      <% @results.map(&:event).uniq.each do |event| %>
        <span class="event-radio">
          <%= label_tag "radio-#{event.id}" do %>
            <%= radio_button_tag "results_event", event.id, params[:results_event] == event.id, id: "radio-#{event.id}" %>
            <%= content_tag(:span, "", class: "cubing-icon event-#{event.id}", data: { toggle: "tooltip", placement: "top" },
                                       title: event.name ) %>
          <% end %>
        </span>
      <% end %>
    </div>
    <!-- events radio -->
    <div class="table-responsive">
      <table class="table table-striped floatThead">
        <thead>
          <tr>
            <th class="competition"><%= t '.competition' %></th>
            <th class="round"><%= t 'competitions.results_table.round' %></th>
            <th class="place"><%= t '.place' %></th>
            <th class="single"><%= t 'common.single' %></th>
            <th class="regional-single-record"></th>
            <th class="average"><%= t 'common.average' %></th>
            <th class="regional-average-record"></th>
            <th class="solves" colspan="5"><%= t 'common.solves' %></th>
          </tr>
        </thead>
        <% @results.group_by(&:event).each do |event, results| %>
          <tbody class="event-<%= event.id %>">
            <tr>
              <td colspan="12" class="event">
                <%= content_tag :span, "", class: "cubing-icon event-#{event.id}" %>
                <%= t "events.#{event.id}" %>
              </td>
            </tr>
            <% pb_markers = pb_markers(results.reverse) %>
            <% results.group_by(&:competitionId).each do |_, results| %>
              <% results.each_with_index do |result, index| %>
                <tr class="result">
                  <td class="competition">
                    <% if index == 0 %>
                      <%= link_to result.competition.name, result.competition %>
                    <% end %>
                  </td>
                  <td class="round"><%= t "rounds.#{result.roundTypeId}.name" %></td>
                  <td class="place"><%= result.pos %></td>
                  <td class="single <%= 'pb' if pb_markers[result.id][:single] %>">
                    <%= result.best_solve.clock_format %>
                  </td>
                  <td class="regional-single-record"><%= result.regionalSingleRecord %></td>
                  <td class="average <%= 'pb' if pb_markers[result.id][:average] %>">
                    <%= result.average_solve.clock_format %>
                  </td>
                  <td class="regional-average-record"><%= result.regionalAverageRecord %></td>
                  <%= solve_tds_for_result(result) %>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        <% end %>
      </table>
    </div>
  </div>
</div>
