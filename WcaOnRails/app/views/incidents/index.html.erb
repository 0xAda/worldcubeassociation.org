<% provide(:title, "Incidents log") %>

<%= render layout: "nav" do %>
  <h1><%= yield(:title) %></h1>

  <div id="custom-search-toolbar">
    <input id="incident-tags" class="form-control" type="text" placeholder="Filter by tags">
  </div>
  <div class="incidents-log-table-container">
    <%= wca_table(table_class: "incidents-log-table", data: { toggle: "table", pagination: true, search: true, toolbar: "#custom-search-toolbar" }, floatThead: false, greedy: false) do %>
      <thead>
        <tr>
          <th>Name</th>
          <th class="tags-cell">Tags</th>
          <th class="comps-cell">Happened during</th>
          <th class="status-cell">Status</th>
        </tr>
      </thead>

      <tbody>
        <% @incidents.each do |incident| %>
          <tr>
            <td><%= link_to incident.name, incident %></td>
            <td data-tags="<%= incident.tags %>">
              <% incident.tags_array.each do |t| %>
                <%= render "incident_tag", tag: t %>
              <% end %>
            </td>
            <td data-tags="<%= incident.competitions %>">
              <% incident.competitions.each do |c| %>
                <%= render "competition_tag", comp: c %>
              <% end %>
            </td>
            <td><%= incident.status %></td>
          </tr>
        <% end %>
      </tbody>
    <% end %>
  </div>

  <script>
    $('.incidents-log-table').data("customSearch", wca.customIncidentsSearch);
    $('.incidents-log-table').on('search.bs.table', function() {
      // Yep, when it's filtered we need to reactivate popovers :(
      $('[data-toggle="popover"]').popover();
    });

    var opts = wca.defaultSelectizeOptions(<%= all_to_options(IncidentTag) %>);
    // It's a search filter input, so there is no point to allow user to create tags
    delete opts["create"];
    opts["onChange"] = function (value) {
      // Hack to force refresh
      if (wca.incidentsBootstrapTable) {
        wca.incidentsBootstrapTable.searchText = " ";
      }
      $('.incidents-log-table').bootstrapTable('resetSearch', $('.search input').val());
    };
    opts["maxOptions"] = 5;
    $('input#incident-tags').selectize(opts);
  </script>

  <br>
  <% if current_user&.can_manage_incidents? %>
    <%= link_to icon('plus', 'New Incident'), new_incident_path, class: "btn btn-success" %>
  <% end %>

<% end %>
